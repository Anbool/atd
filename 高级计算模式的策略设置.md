## 概述
为了补充标准计算模式的多样性和复杂性，产品提供了策略设置的高级计算模式。在高级计算模式中，可以更加灵活地定义查询语句和触发条件，支持更多应用场景。
## 设置查询语句
支持标准的Elasticsearch(以下简称ES)查询语句
1. 选择索引，选择数据所在的索引。
2. 编辑框内，填写ES查询的body体，查询语句遵循标准的ES查询标准，示例如下：
  ```
    {
      "query": {
        "bool": {
          "must": [
            {
              "range": {
                "time_local": {
                  "gte": "now-5m",
                  "lte": "now"
                }
              }
            }
          ],
          "must_not": []
        }
      },
      "size": 10
    }
  ```

  PS: 更多查询语句可以参考如下链接文档：

  https://www.elastic.co/guide/cn/elasticsearch/guide/current/search-in-depth.html

  主要涉及到结构化搜索，全文搜索，多字段搜索，近似匹配...等。

3. 查询结果。根据(1)选择的索引，以及(2)填写的查询语句，可在ES中检索到相应数据，这里用payload表示查询后的结果，该结果也是定义触发条件的输入。

## 定义触发条件
触发条件需要定义一个触发函数，支持JavaScript语法。
### 触发函数参数：
该函数的输入参数是上一步数据查询的结果-payload，在函数编写过程中可参考页面展示的数据查询结果。
### 触发函数返回值：
通过一系列的触发条件判断编写，
> 若策略触发，则该函数的返回值定义为策略的触发结果。

> 若策略没有触发，则该函数可不返回返回值，或着返回false。

一个简单的触发函数，示例如下：
``` 
function trigger(payload) {
    let result = "payload.hits.total=" + payload.hits.total
    if (payload.hits.total > 5) {
        return result;
    }
}
```
## Q&A
### 如何进行接口请求？
在触发函数编写的过程中，本产品提供了封装好的接口请求函数fetchData，该函数的返回值为请求返回值。
请配合async/await的同步操作使用。即触发函数以async开头，接口请求函数以await开始。示例如下：

```
  fetchData(url, method, headers, body)，其中：
  url: 完整的请求地址，
  method: 请求方法， 
  headers: 请求的headers，不传时默认为{ 'Content-Type': 'application/json' }，
  body: 请求的body体
```
对于一个带接口请求的触发函数，示例如下：
```
async function trigger(payload) {
    let url = "http://xxx/test";
    let method = "get";
    let data = await fetchData(url, method);
    let result = "payload.hits.total=" + payload.hits.total;
    if (payload.hits.total > data.total) {
        return result;
    }
}
```
### 如何进行时间格式化？
对于触发函数中的时间格式化处理，本产品支持moment进行时间格式化。示例如下：
```
var time = moment().unix();
```
